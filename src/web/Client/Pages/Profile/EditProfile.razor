@page "/profile"
@using MudExtensions.Enums
@inject ILookingForCache LookingForCache
@inject IProfileCache ProfileCache
@inject IProfileApiClient ProfileApiClient
@inject ISnackbar Snackbar
@attribute [Authorize]

<MetadataComponent Title="Redigér Profil"
                   Description="Her kan du redigére din profil" />

<MudLoading @bind-Loading="_isLoading" Darken Overlap>
    @if (_userProfile is null)
    {
        return;
    }

    <MudButton Disabled="@(_userProfile.UserName is null)" Href="@($"/{_userProfile.UserName}")" Color="Color.Primary" StartIcon="@Icons.Material.Filled.KeyboardArrowLeft" EndIcon="@Icons.Material.Filled.Person">@(_userProfile.UserName is null ? "Sæt et brugernavn for at gøre din profil offentlig" : "Gå til offentlig profil")</MudButton>

        <EditForm Model="@_userProfile" OnValidSubmit="UpdateUserProfile">

            <DataAnnotationsValidator />

            <MudPaper Elevation="3" Class="pa-4">

                <UserProfilePicture @bind-UserProfile="_userProfile" />
                <MudGrid>
                    <MudItem xs="12" sm="4">
                        <MudTextField Adornment="Adornment.Start" AdornmentText="@("@")" Required For="() => _userProfile.UserName" @bind-Value="@_userProfile.UserName" Label="Brugernavn" Variant="Variant.Text" InputType="InputType.Text" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudTextField For="() => _userProfile.FirstName" @bind-Value="@_userProfile.FirstName" Label="Fornavn" Variant="Variant.Text" InputType="InputType.Text" name="name" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudTextField For="() => _userProfile.LastName" @bind-Value="@_userProfile.LastName" Label="Efternavn" Variant="Variant.Text" InputType="InputType.Text" name="lastname" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudNumericField For="() => _userProfile.ZipCode" @bind-Value="@_userProfile.ZipCode" Label="Postnummer" Placeholder="8000" Variant="Variant.Text" name="zipcode" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudTextField For="() => _userProfile.City" @bind-Value="@_userProfile.City" Label="By" Placeholder="Aarhus C" Variant="Variant.Text" InputType="InputType.Text" name="city" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudDatePicker AdornmentColor="Color.Primary"
                                   Color="Color.Primary"
                                      Rounded
                                   Placeholder="@DateTime.Now.ToString("d")"
                                   For="() => _userProfile.DateOfBirth"
                                   OpenTo="OpenTo.Year"
                                   PickerVariant="PickerVariant.Dialog"
                    @bind-Date="@_userProfile.DateOfBirth"
                                   Label="Fødselsdato"
                                   name="dob" />
                </MudItem>
                <MudItem xs="12">
                    <MudSelectExtended ItemCollection="_lookingFor.Select(e => e.Name).ToList()"
                                       T="string"
                                       Label="Interesseret i"
                                       MultiSelection="true"
                                       SelectedValues="_userProfile.LookingFor.Select(e => e.Name)"
                                       ValuePresenter="ValuePresenter.Chip"
                                       SelectedValuesChanged="SelectedLookingForChanged">
                    </MudSelectExtended>
                </MudItem>
                <MudItem xs="12">
                    <MudTextFieldExtended For="() => _userProfile.Description"
                                                    AutoSize
                                          Lines="3"
                                                    Immediate
                    @bind-Value="@_userProfile.Description"
                                          Placeholder="Du kan eksempelvis fortælle om dine interesser, uddanelse, familie, børnesyn, værdier og den slags."
                                          Label="Beskrivelse"
                                          Variant="Variant.Text"
                                          InputType="InputType.Text" />
                    </MudItem>
                    </MudGrid>

                    </MudPaper>


                    <MudText Class="mt-10 mb-5" Typo="Typo.h5"><MudIcon Class="mr-2" Icon="@Icons.Material.Filled.ChildCare" />Børn</MudText>


                    <EditChildProfileTabs @bind-Parent="_userProfile"></EditChildProfileTabs>

                    <MudButton Size="Size.Large"
                               StartIcon="@Icons.Material.Filled.Save"
                               Class="my-6"
                               ButtonType="ButtonType.Submit"
                               Variant="Variant.Filled"
                   FullWidth
                   Color="Color.Primary">
            Gem
        </MudButton>

    </EditForm>
</MudLoading>
@code {
    private bool _isLoading = true;
    private UserProfile? _userProfile;
    private IEnumerable<LookingFor> _lookingFor = Enumerable.Empty<LookingFor>();

    private readonly Action<SnackbarOptions> _snackbarOptions = options =>
    {
        options.CloseAfterNavigation = true;
        options.VisibleStateDuration = 3000;
        options.ShowTransitionDuration = 250;
    };

    protected override async Task OnInitializedAsync()
    {
        var userProfile = await ProfileCache.GetOrCreateProfileAsync();
        if (userProfile is null)
        {
            Snackbar.Add("Det lykkedes ikke at hente dine informationer. Vent et øjeblik og genindlæs så siden.",
                Severity.Warning, _snackbarOptions);
            return;
        }
        _userProfile = userProfile;

        _isLoading = false;
        _lookingFor = await LookingForCache.GetOrCreateLookingForAsync();
    }

    private async Task UpdateUserProfile()
    {
        _isLoading = true;
        var response = await ProfileApiClient.UpdateUserProfile(_userProfile!);
        if (response.IsSuccessStatusCode)
        {
            ProfileCache.SetProfile(_userProfile!);
            Snackbar.Add("Dine oplysninger er blevet gemt.", Severity.Success, _snackbarOptions);
        }
        else
        {
            Snackbar.Add("Det lykkedes ikke at opdatere dine informationer. Vent et øjeblik før du prøver igen.", Severity.Warning, _snackbarOptions);
        }
        _isLoading = false;
    }

    private void SelectedLookingForChanged(IEnumerable<string> lookingFor)
    {
        _userProfile!.LookingFor = _lookingFor.Where(e => lookingFor.Contains(e.Name)).ToList();
    }
}
