@page "/users"
@using Jordnaer.Shared.UserSearch
@using System.Net
@inject IUserSearchApiClient UserSearchApi
@inject ISnackbar Snackbar
@inject ILocalStorageService LocalStorage

<MudLoading @bind-Loading="_isSearching" Darken Overlap>

    <UserSearchForm OnValidSubmit="@UserSearch" @bind-Filter="_filter" />

    @if (!_hasSearched)
    {
        return;
    }

    <SponsorAd />

    <UserSearchResultComponent Filter="_filter" SearchResult="_searchResult" SelectedPageChanged="@OnSelectedPageChanged" />
</MudLoading>
@code {
    private UserSearchFilter _filter = new();
    private UserSearchResult _searchResult = new();
    private bool _isSearching = false;
    private bool _hasSearched = false;

    protected override async Task OnInitializedAsync()
    {
        _isSearching = true;
        var savedSearchResult = await LocalStorage.GetItemAsync<UserSearchResult>(nameof(UserSearchResult));
        var savedSearchFilter = await LocalStorage.GetItemAsync<UserSearchFilter>(nameof(UserSearchFilter));
        _isSearching = false;
        if (savedSearchResult is not null)
        {
            _searchResult = savedSearchResult;
            _hasSearched = true;
        }
        if (savedSearchFilter is not null)
        {
            _filter = savedSearchFilter;
        }
    }

    private async Task UserSearch()
    {
        _isSearching = true;
        var response = await UserSearchApi.GetUsers(_filter);
        if (response.IsSuccessStatusCode)
        {
            _searchResult = response.Content!;
            _hasSearched = true;
            await LocalStorage.SetItemAsync(nameof(UserSearchResult), _searchResult);
            await LocalStorage.SetItemAsync(nameof(UserSearchFilter), _filter);
        }
        else if (response.StatusCode is HttpStatusCode.TooManyRequests)
        {
            Snackbar.Add(ErrorMessages.High_Load, Severity.Info);
        }
        else
        {
            Snackbar.Add(ErrorMessages.Something_Went_Wrong_Try_Again, Severity.Warning);
        }

        _isSearching = false;
    }

    private async Task OnSelectedPageChanged(int selectedPage)
    {
        _filter.PageNumber = selectedPage;
        await UserSearch();
    }

}
