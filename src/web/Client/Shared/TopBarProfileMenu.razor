@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@inject AuthStateProvider Client
@inject NavigationManager Navigation
@inject IProfileCache ProfileCache
@inject ILocalStorageService LocalStorage

<MudMenu IconColor="Color.Primary" AnchorOrigin="Origin.BottomCenter">
    <ActivatorContent>
        <MudAvatar>
            <MudImage Src="@_profilePictureUrl" loading="lazy" />
        </MudAvatar>
    </ActivatorContent>
    <ChildContent>
        <MudMenuItem Icon="@Icons.Material.Filled.Person" Href="profile">Redig√©r Profil</MudMenuItem>
        <MudMenuItem AutoClose="false"
                     OnClick="UpdateDarkMode"
                     Icon="@(IsDarkMode ? Icons.Material.Filled.DarkMode : Icons.Material.Filled.LightMode)"
                     IconColor="@(IsDarkMode ? Color.Dark : Color.Warning)">
            Skift tema
        </MudMenuItem>
        <MudDivider />
        <MudMenuItem Icon="@Icons.Material.Filled.Logout"
                     OnClick="Logout"
                     OnTouch="Logout">
            Log af
        </MudMenuItem>
    </ChildContent>
</MudMenu>
@code {
    [Parameter]
    public bool IsDarkMode { get; set; }
    [Parameter]
    public EventCallback<bool> IsDarkModeChanged { get; set; }

    private const string Key = "dark-mode";

    private string _profilePictureUrl = ProfileConstants.Default_Profile_Picture;

    protected override async Task OnInitializedAsync()
    {
        var userProfile = await ProfileCache.GetOrCreateProfileAsync();
        if (userProfile?.ProfilePictureUrl is not null)
        {
            _profilePictureUrl = userProfile.ProfilePictureUrl;
        }
    }

    private async Task Logout()
    {
        await Client.LogoutAsync();
        Navigation.NavigateToLogout("/");
    }

    private async Task UpdateDarkMode()
    {
        IsDarkMode = !IsDarkMode;
        await IsDarkModeChanged.InvokeAsync(IsDarkMode);

        await LocalStorage.SetItemAsync(Key, IsDarkMode);

        StateHasChanged();
    }
}
