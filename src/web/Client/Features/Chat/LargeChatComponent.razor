@inject IChatService ChatService
@inject IProfileCache ProfileCache
@inject ISnackbar Snackbar
@inject IJSRuntime JsRuntime
@inject ChatSignalRClient ChatSignalRClient
@attribute [Authorize]

@if (_currentUser is null)
{
    return;
}

<MudLoading @bind-Loading="_isLoading" Darken Overlap>
    <MudGrid Style="height: 600px">
        <MudItem Class="chat-selector-window" md="3" lg="3" xl="3" xxl="3">
            <MudList Clickable>
                <MudListSubheader>
                    <UserAutoComplete SelectedUserChanged="StartNewChat" />
                </MudListSubheader>
                @foreach (var chat in _chats)
                {
                    <MudListItem OnClick="@(() => SelectChat(chat))" Dense="true" Class="chat-selector">

                        <MudAvatar Size="Size.Large" Class="mr-3">
                            <MudImage Src="@chat.GetChatImage(_currentUser.Id)" loading="lazy" Alt="Avatar" />
                        </MudAvatar>
                        <MudText>
                            @if (chat.HasUnreadMessages)
                            {
                                <b>@chat.GetDisplayName(_currentUser.Id) (@chat.UnreadMessageCount)</b>
                            }
                            else
                            {
                                @chat.GetDisplayName(_currentUser.Id)
                            }
                        </MudText>

                    </MudListItem>
                    <MudDivider DividerType="DividerType.FullWidth" />

                }
            </MudList>
        </MudItem>

        <MudItem md="1" lg="1" xl="1" xxl="1">
            <MudDivider Vertical DividerType="DividerType.FullWidth" />
        </MudItem>

        <MudItem id="chat-message-window" Class="chat-message-window" md="8" lg="8" xl="8" xxl="8">
            @if (_activeChat != null)
            {
                <MudList Class="chat-message-list" DisablePadding Dense>
                @* ReSharper disable once UnusedParameter.Local *@
                <Virtualize Items="_activeChat.Messages" Context="message" OverscanCount="8" ItemSize="80">
                    @if (IsMessageFromSelf(message))
                        {
                            <MudListItem Class="message-from-self">

                                <MudTooltip Placement="Placement.Top" ShowOnClick ShowOnHover="false" Arrow Text="@message.SentUtc.DisplayExactTime()">
                                <MudTooltip ShowOnHover Arrow Text="@message.SentUtc.DisplayTimePassed()">
                                    <MudChip Text="@message.Text"
                                             Class="chat-chip px-2 py-1" />
                                </MudTooltip>
                            </MudTooltip>
                        </MudListItem>
                        }
                        else
                        {
                            <MudListItem>
                                <MudTooltip Placement="Placement.Top" ShowOnClick ShowOnHover="false" Arrow Text="@message.SentUtc.DisplayExactTime()">
                                <MudTooltip ShowOnHover Arrow Text="@message.SentUtc.DisplayTimePassed()">
                                    <MudChip Class="pl-0 pb-0 chat-chip">
                                        <MudAvatar Size="Size.Medium" Class="mr-2">
                                            <MudImage Src="@GetRecipientsProfilePictureUrl(message)" loading="lazy" Alt="Avatar" />
                                        </MudAvatar>
                                        @message.Text
                                    </MudChip>
                                </MudTooltip>
                            </MudTooltip>
                        </MudListItem>
                        }

                    </Virtualize>
                    @if (LastMessageWasSentSuccessfully)
                    {
                        <div title="Din besked er blevet sendt" class="message-sent-successfully-container">
                            <MudIcon Icon="@Icons.Material.Outlined.CheckCircleOutline"
                                     Class="message-sent-successfully" />
                        </div>
                    }

                    <MudTextField @bind-Value="_userText"
                                    FullWidth
                                    Immediate
                                    AutoFocus
                                  id="chat-message-input"
                                  Class="chat-message-input"
                                  Adornment="Adornment.End"
                                  TextUpdateSuppression="false"
                                  OnKeyDown="SendMessageOnEnter"
                                  AdornmentIcon="@Icons.Material.Filled.Send"
                                  AdornmentColor="@(string.IsNullOrEmpty(_userText) ? Color.Default : Color.Primary)"
                                  OnAdornmentClick="SendMessage" />
                </MudList>
            }

        </MudItem>
    </MudGrid>

</MudLoading>
@code {
    private UserProfile? _currentUser;
    private UserSlim _currentUserSlim = null!;
    private List<ChatDto> _chats = new();
    private ChatDto? _activeChat;

    private string _userText = string.Empty;

    private bool _isActiveChatPublished = true;
    private bool _isLoading = true;

    private Dictionary<Guid, Guid> _lastSuccessfullySentMessageForChat = new();
    private bool LastMessageWasSentSuccessfully
    {
        get
        {
            if (_activeChat is null)
            {
                return false;
            }
            var lastMessage = _activeChat.Messages.LastOrDefault();
            if (lastMessage is null)
            {
                return false;
            }
            var lastMessageIsFromCurrentUser = lastMessage.SenderId == _currentUser!.Id;

            var lastMessageWasSuccessfullySent = _lastSuccessfullySentMessageForChat.TryGetValue(_activeChat.Id, out var lastSuccessfullySentMessage) &&
                                                 lastSuccessfullySentMessage == lastMessage.Id;

            return lastMessageIsFromCurrentUser && lastMessageWasSuccessfullySent;
        }
    }

    // TODO: Select currently displayed chat using this, when we update to dotnet 8
    [SupplyParameterFromQuery]
    public Guid? ChatId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        _currentUser = await ProfileCache.GetOrCreateProfileAsync();
        if (_currentUser is null)
        {
            Snackbar.Add(ErrorMessages.Something_Went_Wrong_Refresh, Severity.Warning);
            return;
        }

        _currentUserSlim = _currentUser.ToUserSlim();

        _chats = await ChatService.GetChats(_currentUser.Id);

        ChatSignalRClient.OnChatStarted(chat =>
        {
            if (chat.InitiatorId == _currentUser.Id)
            {
                return;
            }

            var chatDto = chat.ToChatDto();
            chatDto.UnreadMessageCount++;
            _chats.Insert(0, chatDto);

            StateHasChanged();
        });

        ChatSignalRClient.OnMessageReceived(async message =>
        {
            var chat = _chats.FirstOrDefault(chat => chat.Id == message.ChatId);
            if (chat is null)
            {
                return;
            }
            if (message.SenderId == _currentUser.Id)
            {
                _lastSuccessfullySentMessageForChat[chat.Id] = message.Id;
                return;
            }

            chat.Messages.Add(message);

            if (_activeChat?.Id == chat.Id)
            {
                await ChatService.MarkMessagesAsRead(message.ChatId);
                StateHasChanged();
                await ScrollToBottom();
            }
            else
            {
                _chats = _chats.OrderByDescending(c => c.UnreadMessageCount).ToList();
                chat.UnreadMessageCount++;
                StateHasChanged();
            }
        });
        await ChatSignalRClient.StartAsync();

        _isLoading = false;
    }

    public async Task LoadMessages()
    {
        if (_activeChat is null)
        {
            Snackbar.Add(ErrorMessages.Something_Went_Wrong_Refresh, Severity.Warning);
            return;
        }

        _activeChat.Messages = await ChatService.GetChatMessages(_activeChat.Id);

        StateHasChanged();

        await ScrollToBottom();
    }

    private async Task SelectChat(ChatDto chat)
    {
        _activeChat = chat;
        if (_isActiveChatPublished)
        {
            await LoadMessages();
            // We call this twice to ensure we're at the very bottom. Silly but easy
            await ScrollToBottom();

            if (chat.HasUnreadMessages)
            {
                await ChatService.MarkMessagesAsRead(_activeChat.Id);
                chat.UnreadMessageCount = 0;
            }
        }
    }

    private async Task ScrollToBottom() => await JsRuntime.InvokeVoidAsync("scrollFunctions.scrollToTheBottomOfChat");

    private void BackToList() => _activeChat = null;

    private async Task SendMessage()
    {
        if (_activeChat is null || string.IsNullOrWhiteSpace(_userText))
        {
            return;
        }

        var message = new ChatMessageDto
            {
                ChatId = _activeChat.Id,
                Id = NewId.NextGuid(),
                SentUtc = DateTime.UtcNow,
                SenderId = _currentUserSlim.Id,
                Text = _userText
            };

        _activeChat.Messages.Add(message);
        _userText = string.Empty;

        if (_isActiveChatPublished)
        {
            await ChatService.SendMessage(message);
        }
        else
        {
            await ChatService.StartChat(_activeChat.ToStartChatCommand(_currentUser!.Id));
            _isActiveChatPublished = true;
        }

        await ScrollToBottom();
    }

    private async Task SendMessageOnEnter(KeyboardEventArgs keyboardEventArgs)
    {
        if (keyboardEventArgs is { Key: "Enter", ShiftKey: false })
        {
            await SendMessage();
        }
    }

    private bool IsMessageFromSelf(ChatMessageDto message) => message.SenderId == _currentUser!.Id;

    private async Task StartNewChat(IEnumerable<UserSlim> users)
    {
        var userList = users.ToList();
        if (userList.Count() == 1)
        {
            var userIdsToFind = new[] { userList.First().Id, _currentUser!.Id };
            var existingChat = _chats.FirstOrDefault(chat => chat.Recipients.Count == 2 &&
                                                             userIdsToFind.All(id => chat.Recipients.Any(recipient => recipient.Id == id)));
            if (existingChat is not null)
            {
                await SelectChat(existingChat);

                return;
            }
        }

        var newChat = new ChatDto
            {
                Id = NewId.NextGuid(),
                Recipients = new List<UserSlim> { _currentUserSlim },
                LastMessageSentUtc = DateTime.UtcNow,
                StartedUtc = DateTime.UtcNow
            };

        foreach (var user in userList.Where(u => u.Id != _currentUser!.Id))
        {
            newChat.Recipients.Add(new UserSlim
                {
                    DisplayName = user.DisplayName,
                    Id = user.Id,
                    ProfilePictureUrl = user.ProfilePictureUrl
                });
        }

        _chats.Insert(0, newChat);

        _isActiveChatPublished = false;

        await SelectChat(newChat);
    }

    private string GetRecipientsProfilePictureUrl(ChatMessageDto message)
    {
        return _activeChat?.Recipients.FirstOrDefault(recipient => recipient.Id == message.SenderId)?.ProfilePictureUrl ?? ProfileConstants.Default_Profile_Picture;
    }

}
