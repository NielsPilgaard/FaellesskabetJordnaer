@using System.Globalization
@using System.Security.Claims
@using Jordnaer.Shared.Contracts

<MudGrid>
    <MudItem md="4" lg="4" xl="4" xxl="4">
        <MudList Clickable>
            <MudListSubheader>
                <MudText>TODO: Place user search here</MudText>
            </MudListSubheader>
            @foreach (var chat in _chats)
            {
                <MudListItem OnClick="@(() => SelectChat(chat))" Avatar="@ProfileConstants.Default_Profile_Picture">
                    <MudText>@chat.DisplayName</MudText>
                </MudListItem>
            }
        </MudList>
    </MudItem>

    <MudItem md="8" lg="8" xl="8" xxl="8">
        @if (_activeChat != null)
        {
            <MudList>
                @foreach (var message in _activeChat.Messages)
                {
                    <MudListItem Avatar="@message.Sender.ProfilePictureUrl">
                        <MudChip >@message.Text</MudChip>
                    </MudListItem>
                }
            </MudList>
            <MudTextField @bind-Value="_newMessage" FullWidth Immediate Adornment="Adornment.End" TextUpdateSuppression="false" OnKeyDown="SendMessageOnEnter" AdornmentIcon="@Icons.Material.Filled.Send" AdornmentColor="Color.Primary" OnAdornmentClick="SendMessage" />
        }
    </MudItem>
</MudGrid>
@code {
    [Parameter]
    public required UserProfile User { get; set; }

    private List<ChatUserDto> _chatUsers = TestData.ChatUserDtos;

    private List<ChatDto> _chats = TestData.ChatDtos.ToList();
    
    private ChatDto? _activeChat;

    private void SelectChat(ChatDto chat) => _activeChat = chat;

    private void BackToList() => _activeChat = null;

    private string _newMessage = string.Empty;

    private void SendMessage()
    {
        if (_activeChat is not null && !string.IsNullOrWhiteSpace(_newMessage))
        {
            _activeChat.Messages.Add(new ChatMessageDto
                {
                    Sender = new ChatUserDto
                    {
                        DisplayName = $"{User.FirstName} {User.LastName}",
                        Id = User.Id,
                        ProfilePictureUrl = User.ProfilePictureUrl
                    },
                    Text = _newMessage
                });

            _newMessage = string.Empty;
        }
        else
        {
            //TODO: Add error message
        }
    }

    private void SendMessageOnEnter(KeyboardEventArgs keyboardEventArgs)
    {
        if (keyboardEventArgs.Key is "Enter")
        {
            SendMessage();
        }
    }
}
