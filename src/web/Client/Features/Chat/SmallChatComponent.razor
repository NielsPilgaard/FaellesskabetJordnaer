@using System.Globalization
@using Jordnaer.Shared.Contracts
@if (_activeChat is null)
{
    <MudList>
        @foreach (var chat in _chats)
        {
            <MudListItem OnClick="@(() => SelectChat(chat))" Avatar="@ProfileConstants.Default_Profile_Picture">
                <MudText>@chat.Sender</MudText>
            </MudListItem>
        }
    </MudList>

}
else
{
    <MudFab StartIcon="@Icons.Material.Filled.ArrowBack" OnClick="BackToList" Color="Color.Primary" />

    <MudText>@_activeChat!.Sender</MudText>

    <MudList>
        @foreach (var message in _activeChat!.Messages)
        {
            <MudListItem>
                @message.SentUtc.ToLocalTime().ToString(CultureInfo.CurrentCulture): @message.Text
            </MudListItem>
        }
    </MudList>
}

@code {
    private List<Chat> _chats = new();
    private Chat? _activeChat;

    protected override void OnInitialized()
    {
        _chats = new List<Chat>
      {
        new()
        {
          Sender = "User 1",
          Messages = new List<ChatMessage>
          {
            new() {Sender = "User 1", Text = "Hello!", SentUtc = DateTime.UtcNow.AddMinutes(-5)},
            new() {Sender = "Me", Text = "Hi, how are you?", SentUtc = DateTime.UtcNow.AddMinutes(-2)},
          }
        },
        new()
        {
          Sender = "User 1",
          Messages = new List<ChatMessage>
          {
            new() {Sender = "User 1", Text = "Hello!", SentUtc = DateTime.Now.AddMinutes(-125)},
            new() {Sender = "Me", Text = "Hi, how are you?", SentUtc = DateTime.Now.AddMinutes(-95)},
            new() {Sender = "User 1", Text = "I'm doing well, thank you!", SentUtc = DateTime.Now.AddMinutes(-75)},
          }
        },
        new()
        {
          Sender = "User 2",
          Messages = new List<ChatMessage>
          {
            new() {Sender = "User 2", Text = "Hey, what's up?", SentUtc = DateTime.Now.AddMinutes(-50)},
            new() {Sender = "Me", Text = "Not much, you?", SentUtc = DateTime.Now.AddMinutes(-25)},
            new() {Sender = "User 2", Text = "Just working on a project", SentUtc = DateTime.Now.AddMinutes(-15)},
          }
        }
      };
    }

    private void SelectChat(Chat chat) => _activeChat = chat;

    private void BackToList() => _activeChat = null;

    private string _newMessage = string.Empty;

    private void SendMessage()
    {
        if (_activeChat is not null && !string.IsNullOrWhiteSpace(_newMessage))
        {
            _activeChat.Messages.Add(new ChatMessage { Sender = "Me", Text = _newMessage });
            _newMessage = string.Empty;
        }
    }
}
